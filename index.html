<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß GTRbarber</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 500px; }
        .card { background-color: white; padding: 25px; border-radius: 12px; box-shadow: 0 6px 12px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; }
        h1, h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: 'Sarabun', sans-serif; font-size: 16px; }
        button { width: 100%; padding: 12px; background: linear-gradient(45deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; font-size: 16px; font-family: 'Sarabun', sans-serif; cursor: pointer; margin-top: 20px; transition: transform 0.2s, box-shadow 0.2s; font-weight: bold; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 400px; text-align: center; border-radius: 12px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: slideIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 32px; font-weight: bold; cursor: pointer; }
        .account-details { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin: 20px 0; border-radius: 8px; text-align: left; }
        .account-details p { margin: 8px 0; font-size: 1.1em;}
        #slip-preview { max-width: 100px; margin-top: 10px; border: 1px solid #ddd; padding: 3px; border-radius: 4px; display: none; }
        input[type="file"] { border: 1px solid #ccc; padding: 10px; border-radius: 8px; background-color: #f9f9f9; }
        #booking-history-list { list-style: none; padding: 0; }
        .history-item { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ced4da; }
        .history-item p { margin: 0 0 5px 0; }
        .history-item .status { font-weight: bold; }
        .status-pending-approval { border-left-color: #fd7e14; color: #fd7e14; }
        .status-pending-payment { border-left-color: #0d6efd; color: #0d6efd; }
        .status-pending-confirmation { border-left-color: #ffc107; color: #ffc107; }
        .status-confirmed { border-left-color: #198754; color: #198754; }
        .pay-btn { width: auto; padding: 5px 10px; font-size: 14px; margin-top: 10px; }
        .clear-btn { background: #e74c3c; font-size: 14px; padding: 8px; margin-top: 15px; }
        .clear-btn:hover { background: #c0392b; }
        #availability-result { margin-top: 15px; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; display: none; }
        .status-info { background-color: #e7f3fe; color: #0c5460; }
        .refresh-btn { font-size: 14px; padding: 8px; margin-top: 0px; background: #2ecc71; }
        .refresh-btn:hover { background: #27ae60; }
        .history-header { display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Section 1: New Booking Request -->
        <div class="card">
            <h1>üßî‚Äç‚ôÇÔ∏è ‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß GTRbarber</h1>
            
            <div id="check-day-section">
                <label for="booking-date">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:</label>
                <input type="date" id="booking-date" required>
                <button id="check-day-btn">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏¥‡∏ß</button>
            </div>

            <div id="availability-result"></div>

            <form id="booking-request-form" style="display: none;">
                <hr style="margin-top: 20px;">
                <label for="booking-time">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤:</label>
                <input type="time" id="booking-time" required>
                <label for="name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
                <input type="text" id="name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>
                <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
                <input type="tel" id="phone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0812345678" required>
                <label for="age-group">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏≤‡∏¢‡∏∏:</label>
                <select id="age-group" required>
                    <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                    <option value="child">‡∏ß‡∏±‡∏¢‡πÄ‡∏î‡πá‡∏Å (‡∏°‡∏±‡∏î‡∏à‡∏≥ 40 ‡∏ö‡∏≤‡∏ó)</option>
                    <option value="teen">‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô (‡∏°‡∏±‡∏î‡∏à‡∏≥ 80 ‡∏ö‡∏≤‡∏ó)</option>
                    <option value="adult">‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà (‡∏°‡∏±‡∏î‡∏à‡∏≥ 100 ‡∏ö‡∏≤‡∏ó)</option>
                </select>
                <button type="submit">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</button>
            </form>
        </div>

        <!-- Section 2: Booking History -->
        <div class="card">
            <div class="history-header">
                <h2>üìñ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
                <button id="refresh-history-btn" class="refresh-btn">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            <ul id="booking-history-list">
                <!-- Booking history will be loaded here -->
            </ul>
            <button id="clear-history-btn" class="clear-btn" style="display: none;">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</h2>
            <p id="deposit-amount" style="font-size: 1.2em; font-weight: bold;"></p>
            <div class="account-details">
                <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</p>
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> 6628069664</p>
                <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ‡∏Å‡∏£‡∏¥‡∏ï‡∏©‡∏é‡∏≤ ‡∏Å‡∏£‡∏£‡∏§‡∏ó‡∏ò‡∏¥‡πå</p>
            </div>
            <label for="slip-upload" style="margin-top: 15px; font-weight: bold;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</label>
            <input type="file" id="slip-upload" accept="image/*" required>
            <img id="slip-preview" src="" alt="Slip Preview">
            <p style="font-size: 0.9em; color: #e74c3c; margin-top: 20px;">*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô*</p>
            <button id="confirm-payment-button" disabled>‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC_4a9EIXdNrehWSrXSjw-6amcD2gFm9cE",
            authDomain: "mybarbershop-73642.firebaseapp.com",
            projectId: "mybarbershop-73642",
            storageBucket: "mybarbershop-73642.appspot.com",
            messagingSenderId: "741551490879",
            appId: "1:741551490879:web:f32c81559e385de269758a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const checkDayBtn = document.getElementById('check-day-btn');
        const bookingDateInput = document.getElementById('booking-date');
        const availabilityResult = document.getElementById('availability-result');
        const requestForm = document.getElementById('booking-request-form');
        const historyList = document.getElementById('booking-history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const refreshHistoryBtn = document.getElementById('refresh-history-btn');
        const paymentModal = document.getElementById('payment-modal');
        const closeModalButton = paymentModal.querySelector('.close-button');
        const confirmPaymentButton = document.getElementById('confirm-payment-button');
        const depositAmountText = document.getElementById('deposit-amount');
        const slipUploadInput = document.getElementById('slip-upload');
        const slipPreview = document.getElementById('slip-preview');
        let activeBookingForPayment = null;

        // --- Logic for Checking Day Availability ---
        checkDayBtn.addEventListener('click', async () => {
            const selectedDate = bookingDateInput.value;
            if (!selectedDate) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            checkDayBtn.disabled = true;
            checkDayBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
            availabilityResult.style.display = 'none';
            requestForm.style.display = 'none';

            try {
                const startOfDay = `${selectedDate}T00:00`;
                const endOfDay = `${selectedDate}T23:59`;

                const bookingsRef = collection(db, "bookings");
                const q = query(bookingsRef, where("originalTime", ">=", startOfDay), where("originalTime", "<=", endOfDay));
                const querySnapshot = await getDocs(q);
                
                const bookedCount = querySnapshot.size;

                availabilityResult.style.display = 'block';
                availabilityResult.textContent = `‚ÑπÔ∏è ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ${bookedCount} ‡∏Ñ‡∏¥‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á`;
                availabilityResult.className = 'status-info';
                requestForm.style.display = 'block';

            } catch (error) {
                console.error("Error checking day availability:", error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏¥‡∏ß');
            } finally {
                checkDayBtn.disabled = false;
                checkDayBtn.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏¥‡∏ß';
            }
        });

        // --- Logic for Sending Booking Request ---
        requestForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const submitButton = requestForm.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠...';

            try {
                const selectedDate = bookingDateInput.value;
                const selectedTime = document.getElementById('booking-time').value;
                if (!selectedTime) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á');
                    return;
                }
                const timeValue = `${selectedDate}T${selectedTime}`;
                
                const bookingsRef = collection(db, "bookings");
                const q = query(bookingsRef, where("originalTime", "==", timeValue));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô');
                    return;
                }

                const bookingId = `GTR-${Math.floor(1000 + Math.random() * 9000)}`;
                const deposits = { child: 40, teen: 80, adult: 100 };
                const ageGroup = document.getElementById('age-group').value;

                const newBookingData = {
                    bookingId: bookingId,
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    deposit: deposits[ageGroup],
                    time: new Date(timeValue).toLocaleString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
                    originalTime: timeValue,
                    status: 'pending-approval',
                    slipImage: null,
                    createdAt: new Date()
                };

                await addDoc(collection(db, "bookings"), newBookingData);
                
                let localBookings = JSON.parse(localStorage.getItem('gtrBarberBookings')) || [];
                localBookings.push(bookingId);
                localStorage.setItem('gtrBarberBookings', JSON.stringify(localBookings));

                alert(`‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ${bookingId}\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∂‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô`);
                requestForm.reset();
                requestForm.style.display = 'none';
                availabilityResult.style.display = 'none';
                bookingDateInput.value = '';
                loadBookingHistory();

            } catch (error) {
                console.error("Error sending request: ", error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß';
            }
        });

        // --- Logic for Loading and Displaying History ---
        async function loadBookingHistory() {
            historyList.innerHTML = '<li>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥...</li>';
            const localBookings = JSON.parse(localStorage.getItem('gtrBarberBookings')) || [];

            if (localBookings.length === 0) {
                historyList.innerHTML = '<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</li>';
                clearHistoryBtn.style.display = 'none';
                return;
            }

            historyList.innerHTML = '';
            clearHistoryBtn.style.display = 'block';

            for (const bookingId of localBookings) {
                const bookingsRef = collection(db, "bookings");
                const q = query(bookingsRef, where("bookingId", "==", bookingId));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const doc = querySnapshot.docs[0];
                    const bookingData = { id: doc.id, ...doc.data() };
                    renderHistoryItem(bookingData);
                }
            }
        }

        function renderHistoryItem(booking) {
            const item = document.createElement('li');
            item.className = 'history-item';
            
            const statusTranslations = {
                'pending-approval': '‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡πâ‡∏≤‡∏ô',
                'pending-payment': '‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô',
                'pending-confirmation': '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ',
                'confirmed': '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß',
                'completed': '‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß'
            };

            item.innerHTML = `
                <p><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${booking.bookingId}</p>
                <p><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${booking.time}</p>
                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status status-${booking.status}">${statusTranslations[booking.status] || booking.status}</span></p>
            `;

            if (booking.status === 'pending-payment') {
                const payButton = document.createElement('button');
                payButton.textContent = '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥';
                payButton.className = 'pay-btn';
                payButton.onclick = () => {
                    activeBookingForPayment = booking;
                    depositAmountText.textContent = `‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞: ${booking.deposit} ‡∏ö‡∏≤‡∏ó`;
                    slipUploadInput.value = '';
                    slipPreview.style.display = 'none';
                    confirmPaymentButton.disabled = true;
                    paymentModal.style.display = 'block';
                };
                item.appendChild(payButton);
            }

            historyList.prepend(item);
        }

        // --- Logic for Clearing History ---
        clearHistoryBtn.addEventListener('click', () => {
            const isConfirmed = confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ');
            if (isConfirmed) {
                localStorage.removeItem('gtrBarberBookings');
                loadBookingHistory();
            }
        });
        
        // --- Logic for Refreshing History ---
        refreshHistoryBtn.addEventListener('click', loadBookingHistory);


        // --- Logic for Payment Modal ---
        slipUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    slipPreview.src = e.target.result;
                    slipPreview.style.display = 'block';
                    activeBookingForPayment.slipImage = e.target.result;
                    confirmPaymentButton.disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });

        confirmPaymentButton.addEventListener('click', async () => {
            if (!activeBookingForPayment || !activeBookingForPayment.slipImage) return;
            
            confirmPaymentButton.disabled = true;
            confirmPaymentButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';

            try {
                const bookingRef = doc(db, "bookings", activeBookingForPayment.id);
                await updateDoc(bookingRef, {
                    slipImage: activeBookingForPayment.slipImage,
                    status: 'pending-confirmation'
                });

                paymentModal.style.display = 'none';
                alert(`‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: ${activeBookingForPayment.bookingId}\n‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î: ${activeBookingForPayment.time}\n\n(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô)`);
                loadBookingHistory();

            } catch (e) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            } finally {
                confirmPaymentButton.disabled = false;
                confirmPaymentButton.textContent = '‡∏â‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
            }
        });

        closeModalButton.addEventListener('click', () => { paymentModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == paymentModal) { paymentModal.style.display = 'none'; } });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', loadBookingHistory);
    </script>
</body>
</html>
